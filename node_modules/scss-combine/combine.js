var Fs = require('fs');
var Path = require('path');

/**
 * Return the contents of a SCSS file.
 *
 * Will attempt to find files by appending '.scss' and prepending '_' if the
 * the exact path can not be found.
 */
var getScssContents = function(path) {
  var contents = '';

  if (Path.extname(path) === '') {
    path = path + '.scss';
  }

  try {
    contents = Fs.readFileSync(path, 'utf8');
  } catch (e) {
    try {
      path = Path.join(Path.dirname(path), '_' + Path.basename(path));
      contents = Fs.readFileSync(path, 'utf8');
    } catch (e) {}
  }

  return contents;
};

/**
 * Recursively inline SCSS imports.
 */
var combine = function(path) {
  var basePath = Path.dirname(path);
  var contents = getScssContents(path);
  var importRegex = /@import\s+?["'](.+?)["'];/g;

  return contents.replace(importRegex, function(match, importPath){
    var headerText = '/* scss-combine:' + importPath + ' */\n';
    return headerText + combine(Path.join(basePath, importPath));
  });
};

module.exports = combine;
